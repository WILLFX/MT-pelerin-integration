<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Buy xDai via MetaMask</title>
</head>
<body>
  <h1>Buy xDai (Gnosis Chain)</h1>

  <p>1. Connect your MetaMask wallet.</p>
  <p>2. Buy xDai in a new tab.</p>
  <p>3. We'll detect when it arrives in your wallet.</p>

  <button id="connectBtn">Connect Wallet</button>
  <button id="buyBtn" disabled>Buy xDai (opens in new tab)</button>

  <p id="status">Not connected.</p>

  <script>
    let userAddress = null;
    let previousBalance = null;
    const gnosisChainId = '0x64'; // 100 in hex

    async function connectWallet() {
      if (!window.ethereum) {
        alert('Please install MetaMask!');
        return;
      }

      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = accounts[0];
        document.getElementById('status').innerText = `Connected: ${userAddress}`;

        const currentChain = await window.ethereum.request({ method: 'eth_chainId' });
        if (currentChain !== gnosisChainId) {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: gnosisChainId }]
          });
        }

        document.getElementById('buyBtn').disabled = false;

        // Start polling for balance
        startBalancePolling();
      } catch (err) {
        console.error(err);
        alert('Could not connect to MetaMask.');
      }
    }

    async function getXDAIBalance() {
      const balanceHex = await window.ethereum.request({
        method: 'eth_getBalance',
        params: [userAddress, 'latest']
      });

      return parseFloat(parseInt(balanceHex, 16) / 1e18);
    }

    async function startBalancePolling() {
      previousBalance = await getXDAIBalance();
      console.log(`Starting balance polling... Current balance: ${previousBalance} xDai`);

      setInterval(async () => {
        const currentBalance = await getXDAIBalance();
        console.log(`Polled balance: ${currentBalance} xDai`);

        if (currentBalance > previousBalance) {
          document.getElementById('status').innerText = `ðŸŽ‰ xDai Received! Current balance: ${currentBalance}`;
        }

        previousBalance = currentBalance;
      }, 5000); // every 5 seconds
    }

    document.getElementById('connectBtn').addEventListener('click', connectWallet);

    document.getElementById('buyBtn').addEventListener('click', () => {
      const buyUrl = 'https://portfolio.metamask.io/buy?asset=xdai&network=gnosis';
      window.open(buyUrl, '_blank');
    });
  </script>
</body>
</html>





